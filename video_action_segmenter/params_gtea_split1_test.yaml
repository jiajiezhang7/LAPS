# Params for test-time streaming segmentation on GTEA split1
# All commands will run under conda env "laps"

# Motion Tokenizer checkpoint (produced after training)
checkpoint_path: "/home/johnny/action_ws/checkpoints/motion_tokenizer/epochs10_gtea_split1_m10_tracks_only/best.pt"

decoder_window_size: 480

device: "auto"
amp: true

visualize: false

auth: {}

# Input: full Videos folder (or restrict to test list externally)
input:
  type: "folder"
  dir: "/home/johnny/action_ws/online_datasets/gtea/gtea/Videos_test.split1"
  video_exts: [".mp4", ".mov", ".avi", ".mkv"]
  recursive: true
  eof_timeout_seconds: 1.0
  batch:
    enable_parallel: true
    gpu_ids: [0]
    max_procs_per_gpu: 2
    poll_interval_seconds: 0.2

# Sampling & window
target_fps: 10
resize_shorter: 320
stride: 4

debug_fsq: false

# Energy (keep on to also dump JSONL alongside, optional)
energy:
  enable: true
  source: "quantized"
  mode: "token_diff_l2_mean"
  jsonl_output: true
  jsonl_path: "/home/johnny/action_ws/output/gtea/segments_split1"  # write next to segments outputs
  visualize: false
  viz_window: 400
  plot_width: 720
  plot_height: 520
  y_min: null
  y_max: null
  viz_style: enhanced
  theme: academic_blue
  smoothing:
    enable: true
    method: "ema"
    alpha: 0.7
    window: 3
    use_for_seg: true
    visualize_both: false

# Segmentation enabled at test time
segmentation:
  enable: true
  mode: "report"                # fixed | report; report reads threshold JSON
  report_path: "/home/johnny/action_ws/output/gtea/thresholds/split1/best_threshold_quantized_token_diff.json"
  report_key: "optical_flow_mag_mean_best.best_f1.thr"  # threshold_search_with_gt.py default key
  min_len_windows: 2
  output_dir: "/home/johnny/action_ws/output/gtea/segments_split1"
  codec: "mp4v"
  ext: ".mp4"
  align: "center"
  hysteresis_ratio: 0.95
  up_count: 2
  down_count: 2
  cooldown_windows: 1
  max_duration_seconds: 2.0
  min_codes_windows: 2
  export_codes: true
  codes_min_overlap_ratio: 0.25
  skip_if_exists: true
  allow_overlap: true
  export_segments_json: true
  segments_json_suffix: "_segments"

# Export (optional)
export:
  prequant: false
  prequant_dir: "./video_action_segmenter/inference_outputs/stream_prequant"

max_windows: 500000

