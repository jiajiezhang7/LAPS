# 参数文件：window_track_and_save.py
# 用于按窗口 (T=16) 对单个动作片段视频进行 CoTracker 离线跟踪，并为每个窗口输出带轨迹的可视化视频。
# 说明：
# - 该 YAML 中的配置作为默认值；命令行传入的同名参数会覆盖这里的设置。
# - 路径可用绝对或相对路径（相对路径相对于调用时的工作目录）。

# ===== 基础 I/O =====
# 单文件模式：设置 video 为具体文件路径；
# 目录模式：
#   1) 设置 input_dir 为目录路径；或
#   2) 将 video 设置为目录路径（同样按目录模式处理）。
video: /media/johnny/Data/data_motion_tokenizer/cotracker_demo
output_dir: video_action_segmenter/inference_outputs/windows  # 输出根目录

# 目录模式可选参数（若不需要可保持为空/默认）：
# input_dir: /path/to/folder
# recursive: true   # 是否递归搜索子目录，默认 false
# include_exts: [mp4, m4v, mov, avi, mkv]  # 支持列表或逗号分隔字符串
# max_files: 0      # 最多处理的文件数；0 表示不限制

# ===== 预处理：时间重采样与缩放 =====
target_fps: 20          # 读取时的重采样帧率（20Hz）
resize_shorter: 480     # 短边缩放到该尺寸（保持纵横比）

# ===== CoTracker 网格设置 =====
grid_size: 20  # 网格大小；实际关键点数 N = grid_size^2

# ===== 窗口滑动设置 =====
T: 16          # 窗口长度（帧）
stride: 4      # 窗口步长（帧）；常用 4 或 8（与 stream_inference 习惯一致）
max_windows: 0 # 最多处理的窗口数；0 表示处理全部
decoder_window_size: 15  # Motion Tokenizer 解码窗口大小（用于速度归一化，门控阈值基于此）

# ===== 设备设置 =====
device: auto   # auto / cuda / cpu
gpu_id: null   # 当 device=cuda 时可指定 GPU 编号，如 0

# ===== 可视化其它设置 =====
trail: 15        # 每个点的轨迹历史长度（帧）
display_fps: 20  # 输出视频写入的 FPS（与 target_fps 保持一致即可）
point_radius: 3    # 关键点绘制半径
line_thickness: 2 # 轨迹线宽

# ===== 静态点过滤 =====
static_filter_thresh: 1.5 # 静态点过滤阈值（像素）。点在窗口内的最大位移小于此值则被过滤。设为0禁用。

# ===== 门控设置（用于跳过静止窗口） =====
motion_gate:
  enable: true           # 启用静止窗口过滤（基于速度）
  vel_norm_thr: 0.020   # 速度阈值（归一化到 [-1,1] 的 L2 均值）
  min_active_ratio: 0.025 # 活动关键点比例阈值 （0.05: 400个点里，20个点的比例）
  debug: true           # 打开后打印被丢弃窗口的统计

pre_gate:
  enable: true              # 启用前置像素差分快速门控
  resize_shorter: 128       # 差分前将短边缩放到该尺寸
  diff_method: mad          # 差分方法（当前仅支持 MAD）
  pixel_diff_thr: 0.02      # 像素差分阈值（灰度 [0,1]）
  mad_thr: 0.005            # MAD 阈值
  min_active_ratio: 0.05   # 活动像素比例阈值
  debug: true              # 打印被丢弃窗口的统计
